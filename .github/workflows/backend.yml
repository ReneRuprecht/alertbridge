name: Backend

on:
  workflow_call:
    inputs:
      run_integration_tests:
        required: false
        type: boolean
        default: true
      upload_reports:
        description: "Upload test reports"
        required: false
        type: boolean
        default: false
      build:
        description: "Build docker image"
        required: false
        type: boolean
        default: false
      push:
        description: "Push docker image"
        required: false
        type: boolean
        default: false
      push_latest:
        description: "Push latest docker image"
        required: false
        type: boolean
        default: true
      push_tag:
        description: "Push docker image with SHA Tag"
        required: false
        type: boolean
        default: false
    secrets:
      SECRET_KEY:
        required: false
      DOCKER_USERNAME:
        required: false
      DOCKER_TOKEN:
        required: false

jobs:
  test:
    runs-on: self-hosted
    defaults:
      run:
        shell: bash
    container:
      image: reneruprecht/ci-java21jdk
      volumes:
        - /opt/gha-cache/m2:/root/.m2
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Clean
        working-directory: ./backend
        run: ./mvnw -B -ntp clean

      - name: Unit tests
        id: unit-test
        working-directory: ./backend
        run: |
          ./mvnw -B -ntp -DtrimStackTrace=false test

      - name: Integration tests
        id: integration-test
        if: inputs.run_integration_tests
        working-directory: ./backend
        run: |
          ./mvnw -B -ntp -DtrimStackTrace=false failsafe:integration-test failsafe:verify

      - name: Compress test reports
        id: compression
        if: steps.unit-test.outcome == 'success' && inputs.upload_reports == true
        working-directory: ./backend
        run: |
          REPORTS=""
          [ -d target/surefire-reports ] && REPORTS="$REPORTS target/surefire-reports"
          [ -d target/failsafe-reports ] && REPORTS="$REPORTS target/failsafe-reports"

          if [ -n "$REPORTS" ]; then
            tar -czf "test-reports.tar.gz" $REPORTS
          else
            echo "No test reports found"
          fi

      - name: Encrypt test reports
        id: encryption
        if: steps.compression.outcome == 'success' && inputs.upload_reports == true
        working-directory: ./backend
        run: |
          openssl enc -aes-256-cbc -salt -pbkdf2 -k "${{ secrets.SECRET_KEY }}" -in "test-reports.tar.gz" -out "test-reports.tar.gz.enc"

      - name: Upload encrypted test-reports
        if: steps.encryption.outcome == 'success' && inputs.upload_reports == true
        uses: actions/upload-artifact@v6
        with:
          name: "test-reports"
          path: "backend/test-reports.tar.gz.enc"

  docker-build:
    needs: test
    if: inputs.build || inputs.push
    uses: ./.github/workflows/docker-build.yml
    with:
      name: "alertbridge-backend"
      dockerfile: "docker/backend/Dockerfile"
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

  docker-push:
    needs: docker-build
    if: inputs.push
    uses: ./.github/workflows/docker-push.yml
    with:
      image: ${{ needs.docker-build.outputs.image }}
      tag: ${{ needs.docker-build.outputs.tag }}
      push_latest: ${{ inputs.push_latest }}
      push_tag: ${{ inputs.push_tag }}
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
